{"version":3,"file":"webpack-hook-plugin.umd.js","sources":["../src/webpack-hook-plugin.ts"],"sourcesContent":["import {spawn, exec, ChildProcess, ExecException} from 'child_process';\nimport * as os from 'os';\nimport {Compiler} from 'webpack';\n\ninterface HookPluginOptions {\n  onBuildStart?: string[];\n  onBuildEnd?: string[],\n  onBuildExit?: string[],\n  onCompile?: string[],\n  dev?: boolean,\n  safe?: boolean\n}\n\nconst defaultOptions: HookPluginOptions = {\n  onBuildStart: [],\n  onBuildEnd: [],\n  onBuildExit: [],\n  onCompile: [],\n  dev: true,\n  safe: false\n};\n\nclass WebpackHookPlugin {\n  options: HookPluginOptions;\n\n  constructor(options: HookPluginOptions) {\n    this.options = this.mergeOptions(options, defaultOptions);\n  }\n\n  puts(error: ExecException|null) {\n    if (error) {\n      throw error;\n    }\n  }\n\n  spreadStdoutAndStdErr(proc: ChildProcess) {\n    if (proc.stderr) {\n      proc.stderr.pipe(process.stdout);\n    }\n\n    if (proc.stdout) {\n      proc.stdout.pipe(process.stdout);\n    }\n  }\n\n  serializeScript(script: string) {\n    const [command, ...args] = script.split(' ');\n    return {command, args};\n  }\n\n  handleScript(script: string) {\n    if (os.platform() === 'win32' || this.options.safe) {\n      this.spreadStdoutAndStdErr(exec(script, this.puts));\n    } else {\n      const {command, args} = this.serializeScript(script);\n      const proc = spawn(command, args, {stdio: 'inherit'});\n      proc.on('close', this.puts);\n    }\n  }\n\n  mergeOptions(options: HookPluginOptions, defaults: HookPluginOptions) {\n    for (const key in defaults) {\n      if (options.hasOwnProperty(key)) {\n        (defaults as any)[key] = (options as any)[key];\n      }\n    }\n    return defaults;\n  }\n\n  apply(compiler: Compiler) {\n\n    compiler.hooks.compilation.tap('WebpackHookPlugin', (compilation) => {\n      if (this.options.onBuildStart && this.options.onBuildStart.length) {\n        console.log('Executing pre-build scripts');\n        for (let ii = 0; ii < this.options.onBuildStart.length; ii += 1) {\n          this.handleScript(this.options.onBuildStart[ii]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildStart = [];\n        }\n      }\n    });\n\n    compiler.hooks.watchRun.tap('WebpackHookPlugin', () => {\n      if (this.options.onCompile && this.options.onCompile.length) {\n        console.log('Executing compile scripts');\n        for (let ii = 0; ii < this.options.onCompile.length; ii += 1) {\n          this.handleScript(this.options.onCompile[ii]);\n        }\n      }\n    });\n\n    compiler.hooks.afterEmit.tapAsync('WebpackHookPlugin', (compilation, callback) => {\n      if (this.options.onBuildEnd && this.options.onBuildEnd.length) {\n        console.log('Executing post-build scripts');\n        for (let ii = 0; ii < this.options.onBuildEnd.length; ii += 1) {\n          this.handleScript(this.options.onBuildEnd[ii]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildEnd = [];\n        }\n      }\n      callback();\n    });\n\n    compiler.hooks.done.tap('WebpackHookPlugin', () => {\n      if (this.options.onBuildExit && this.options.onBuildExit.length) {\n        console.log('Executing additional scripts before exit');\n        for (let ii = 0; ii < this.options.onBuildExit.length; ii += 1) {\n          this.handleScript(this.options.onBuildExit[ii]);\n        }\n      }\n    });\n  }\n}\n\n// to generate type definitions\nexport default WebpackHookPlugin;\n// to support CommonJS\nmodule.exports =  WebpackHookPlugin;\n// to support ES6 default import\nmodule.exports.default = module.exports;\n"],"names":["os.platform","exec","spawn"],"mappings":";;;;;;EAaA,IAAM,cAAc,GAAsB;MACxC,YAAY,EAAE,EAAE;MAChB,UAAU,EAAE,EAAE;MACd,WAAW,EAAE,EAAE;MACf,SAAS,EAAE,EAAE;MACb,GAAG,EAAE,IAAI;MACT,IAAI,EAAE,KAAK;GACZ,CAAC;EAEF;MAGE,2BAAY,OAA0B;UACpC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,cAAc,CAAC,CAAC;OAC3D;MAED,gCAAI,GAAJ,UAAK,KAAyB;UAC5B,IAAI,KAAK,EAAE;cACT,MAAM,KAAK,CAAC;WACb;OACF;MAED,iDAAqB,GAArB,UAAsB,IAAkB;UACtC,IAAI,IAAI,CAAC,MAAM,EAAE;cACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;WAClC;UAED,IAAI,IAAI,CAAC,MAAM,EAAE;cACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;WAClC;OACF;MAED,2CAAe,GAAf,UAAgB,MAAc;UACtB,IAAA,sBAAsC,EAArC,eAAO,EAAE,kBAA4B,CAAC;UAC7C,OAAO,EAAC,OAAO,SAAA,EAAE,IAAI,MAAA,EAAC,CAAC;OACxB;MAED,wCAAY,GAAZ,UAAa,MAAc;UACzB,IAAIA,WAAW,EAAE,KAAK,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE;cAClD,IAAI,CAAC,qBAAqB,CAACC,kBAAI,CAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;WACrD;eAAM;cACC,IAAA,iCAA8C,EAA7C,oBAAO,EAAE,cAAoC,CAAC;cACrD,IAAM,IAAI,GAAGC,mBAAK,CAAC,OAAO,EAAE,IAAI,EAAE,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAC;cACtD,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;WAC7B;OACF;MAED,wCAAY,GAAZ,UAAa,OAA0B,EAAE,QAA2B;UAClE,KAAK,IAAM,GAAG,IAAI,QAAQ,EAAE;cAC1B,IAAI,OAAO,CAAC,cAAc,CAAC,GAAG,CAAC,EAAE;kBAC9B,QAAgB,CAAC,GAAG,CAAC,GAAI,OAAe,CAAC,GAAG,CAAC,CAAC;eAChD;WACF;UACD,OAAO,QAAQ,CAAC;OACjB;MAED,iCAAK,GAAL,UAAM,QAAkB;UAAxB,iBA4CC;UA1CC,QAAQ,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,CAAC,mBAAmB,EAAE,UAAC,WAAW;cAC9D,IAAI,KAAI,CAAC,OAAO,CAAC,YAAY,IAAI,KAAI,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,EAAE;kBACjE,OAAO,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;kBAC3C,KAAK,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,KAAI,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,EAAE;sBAC/D,KAAI,CAAC,YAAY,CAAC,KAAI,CAAC,OAAO,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC,CAAC;mBAClD;kBACD,IAAI,KAAI,CAAC,OAAO,CAAC,GAAG,EAAE;sBACpB,KAAI,CAAC,OAAO,CAAC,YAAY,GAAG,EAAE,CAAC;mBAChC;eACF;WACF,CAAC,CAAC;UAEH,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,mBAAmB,EAAE;cAC/C,IAAI,KAAI,CAAC,OAAO,CAAC,SAAS,IAAI,KAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,EAAE;kBAC3D,OAAO,CAAC,GAAG,CAAC,2BAA2B,CAAC,CAAC;kBACzC,KAAK,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,KAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,EAAE;sBAC5D,KAAI,CAAC,YAAY,CAAC,KAAI,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC;mBAC/C;eACF;WACF,CAAC,CAAC;UAEH,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,mBAAmB,EAAE,UAAC,WAAW,EAAE,QAAQ;cAC3E,IAAI,KAAI,CAAC,OAAO,CAAC,UAAU,IAAI,KAAI,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,EAAE;kBAC7D,OAAO,CAAC,GAAG,CAAC,8BAA8B,CAAC,CAAC;kBAC5C,KAAK,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,KAAI,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,EAAE;sBAC7D,KAAI,CAAC,YAAY,CAAC,KAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC,CAAC,CAAC;mBAChD;kBACD,IAAI,KAAI,CAAC,OAAO,CAAC,GAAG,EAAE;sBACpB,KAAI,CAAC,OAAO,CAAC,UAAU,GAAG,EAAE,CAAC;mBAC9B;eACF;cACD,QAAQ,EAAE,CAAC;WACZ,CAAC,CAAC;UAEH,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,mBAAmB,EAAE;cAC3C,IAAI,KAAI,CAAC,OAAO,CAAC,WAAW,IAAI,KAAI,CAAC,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE;kBAC/D,OAAO,CAAC,GAAG,CAAC,0CAA0C,CAAC,CAAC;kBACxD,KAAK,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,KAAI,CAAC,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,EAAE;sBAC9D,KAAI,CAAC,YAAY,CAAC,KAAI,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,CAAC;mBACjD;eACF;WACF,CAAC,CAAC;OACJ;MACH,wBAAC;EAAD,CAAC,IAAA;AAED,EAEA;EACA,MAAM,CAAC,OAAO,GAAI,iBAAiB,CAAC;EACpC;EACA,MAAM,CAAC,OAAO,CAAC,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;;;;;;;;"}