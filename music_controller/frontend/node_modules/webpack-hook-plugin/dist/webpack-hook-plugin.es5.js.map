{"version":3,"file":"webpack-hook-plugin.es5.js","sources":["../src/webpack-hook-plugin.ts"],"sourcesContent":["import {spawn, exec, ChildProcess, ExecException} from 'child_process';\nimport * as os from 'os';\nimport {Compiler} from 'webpack';\n\ninterface HookPluginOptions {\n  onBuildStart?: string[];\n  onBuildEnd?: string[],\n  onBuildExit?: string[],\n  onCompile?: string[],\n  dev?: boolean,\n  safe?: boolean\n}\n\nconst defaultOptions: HookPluginOptions = {\n  onBuildStart: [],\n  onBuildEnd: [],\n  onBuildExit: [],\n  onCompile: [],\n  dev: true,\n  safe: false\n};\n\nclass WebpackHookPlugin {\n  options: HookPluginOptions;\n\n  constructor(options: HookPluginOptions) {\n    this.options = this.mergeOptions(options, defaultOptions);\n  }\n\n  puts(error: ExecException|null) {\n    if (error) {\n      throw error;\n    }\n  }\n\n  spreadStdoutAndStdErr(proc: ChildProcess) {\n    if (proc.stderr) {\n      proc.stderr.pipe(process.stdout);\n    }\n\n    if (proc.stdout) {\n      proc.stdout.pipe(process.stdout);\n    }\n  }\n\n  serializeScript(script: string) {\n    const [command, ...args] = script.split(' ');\n    return {command, args};\n  }\n\n  handleScript(script: string) {\n    if (os.platform() === 'win32' || this.options.safe) {\n      this.spreadStdoutAndStdErr(exec(script, this.puts));\n    } else {\n      const {command, args} = this.serializeScript(script);\n      const proc = spawn(command, args, {stdio: 'inherit'});\n      proc.on('close', this.puts);\n    }\n  }\n\n  mergeOptions(options: HookPluginOptions, defaults: HookPluginOptions) {\n    for (const key in defaults) {\n      if (options.hasOwnProperty(key)) {\n        (defaults as any)[key] = (options as any)[key];\n      }\n    }\n    return defaults;\n  }\n\n  apply(compiler: Compiler) {\n\n    compiler.hooks.compilation.tap('WebpackHookPlugin', (compilation) => {\n      if (this.options.onBuildStart && this.options.onBuildStart.length) {\n        console.log('Executing pre-build scripts');\n        for (let ii = 0; ii < this.options.onBuildStart.length; ii += 1) {\n          this.handleScript(this.options.onBuildStart[ii]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildStart = [];\n        }\n      }\n    });\n\n    compiler.hooks.watchRun.tap('WebpackHookPlugin', () => {\n      if (this.options.onCompile && this.options.onCompile.length) {\n        console.log('Executing compile scripts');\n        for (let ii = 0; ii < this.options.onCompile.length; ii += 1) {\n          this.handleScript(this.options.onCompile[ii]);\n        }\n      }\n    });\n\n    compiler.hooks.afterEmit.tapAsync('WebpackHookPlugin', (compilation, callback) => {\n      if (this.options.onBuildEnd && this.options.onBuildEnd.length) {\n        console.log('Executing post-build scripts');\n        for (let ii = 0; ii < this.options.onBuildEnd.length; ii += 1) {\n          this.handleScript(this.options.onBuildEnd[ii]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildEnd = [];\n        }\n      }\n      callback();\n    });\n\n    compiler.hooks.done.tap('WebpackHookPlugin', () => {\n      if (this.options.onBuildExit && this.options.onBuildExit.length) {\n        console.log('Executing additional scripts before exit');\n        for (let ii = 0; ii < this.options.onBuildExit.length; ii += 1) {\n          this.handleScript(this.options.onBuildExit[ii]);\n        }\n      }\n    });\n  }\n}\n\n// to generate type definitions\nexport default WebpackHookPlugin;\n// to support CommonJS\nmodule.exports =  WebpackHookPlugin;\n// to support ES6 default import\nmodule.exports.default = module.exports;\n"],"names":["os.platform"],"mappings":"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"}